# Multi-Cloud Full-Mesh Inter-AZ Latency Measurement

This toolkit automates the measurement of TCP network latency between all Availability Zones in AWS and Azure regions using a full-mesh approach.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                      Control Machine                         │
│  (runs Terraform, orchestrates tests, collects results)     │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│     AWS       │     │     Azure     │     │   Cloud N     │
│ ┌───┐ ┌───┐  │     │ ┌───┐ ┌───┐  │     │ ┌───┐ ┌───┐  │
│ │AZ1│◄─►│AZ2│  │     │ │Z1 │◄─►│Z2 │  │     │ │AZ1│◄─►│AZ2│  │
│ └─┬─┘ └─┬─┘  │     │ └─┬─┘ └─┬─┘  │     │ └─┬─┘ └─┬─┘  │
│   │  ╲╱  │    │     │   │  ╲╱  │    │     │   │  ╲╱  │    │
│   │  ╱╲  │    │     │   │  ╱╲  │    │     │   │  ╱╲  │    │
│ ┌─┴─┐ ┌─┴─┐  │     │ ┌─┴─┐ ┌─┴─┐  │     │ ┌─┴─┐ ┌─┴─┐  │
│ │AZ3│◄─►│AZ4│  │     │ │Z3 │◄─►│Z4 │  │     │ │AZ3│◄─►│AZ4│  │
│ └───┘ └───┘  │     │ └───┘ └───┘  │     │ └───┘ └───┘  │
└───────────────┘     └───────────────┘     └───────────────┘
```

## Components

```
├── terraform/
│   ├── aws/                    # AWS-only deployment (independent state)
│   │   ├── main.tf
│   │   └── modules/aws-region/
│   └── azure/                  # Azure-only deployment (independent state)
│       ├── main.tf
│       └── modules/azure-region/
├── scripts/
│   ├── orchestrate.py          # Runs measurements, generates reports
│   └── generate_report.py      # Report generation utilities
└── results/                    # Output directory (gitignored)
```

## Quick Start

### AWS Only
```bash
# 1. Deploy infrastructure (SSH keys auto-generated)
cd terraform/aws
terraform init
terraform apply

# 2. Run measurements (SSH key auto-detected from terraform)
cd ../../scripts
./orchestrate.py --cloud aws

# 3. Clean up
cd ../terraform/aws
terraform destroy
```

### Azure Only
```bash
# 1. Login to Azure
az login

# 2. Deploy infrastructure (SSH keys auto-generated)
cd terraform/azure
terraform init
terraform apply

# 3. Run measurements (SSH key auto-detected from terraform)
cd ../../scripts
./orchestrate.py --cloud azure

# 4. Clean up
cd ../terraform/azure
terraform destroy
```

### Both Clouds
```bash
# 1. Login to both clouds
az login
aws sso login --profile your-profile

# 2. Deploy both (separate state files)
cd terraform/aws && terraform init && terraform apply
cd ../azure && terraform init && terraform apply

# 3. Run measurements across both clouds
cd ../../scripts
./orchestrate.py --cloud aws --cloud azure

# 4. Clean up
cd ../terraform/aws && terraform destroy
cd ../azure && terraform destroy
```

## Terraform Variables

### AWS (`terraform/aws/`)

| Variable | Default | Description |
|----------|---------|-------------|
| `instance_type` | `c5n.large` | EC2 instance type (network-optimized with up to 25 Gbps bandwidth) |
| `project_name` | `latency-mesh` | Resource naming prefix |

### Azure (`terraform/azure/`)

| Variable | Default | Description |
|----------|---------|-------------|
| `vm_size` | `Standard_D2s_v3` | Azure VM size (D-series required for accelerated networking) |
| `admin_username` | `azureuser` | VM admin username |
| `project_name` | `latency-mesh` | Resource naming prefix |

**Note:** SSH keys are automatically generated by Terraform. No need to provide your own keys.

## Network Optimizations

The infrastructure is configured with network optimizations to minimize cross-zone latency:

### AWS
- **Instance type:** `c5n.large` - Network-optimized instances with:
  - Up to 25 Gbps network bandwidth
  - Enhanced Networking with Elastic Network Adapter (ENA)
  - Lower latency and higher packet-per-second performance

### Azure
- **Accelerated Networking:** Enabled on all NICs
  - Bypasses the host's software networking stack via SR-IOV
  - Reduces latency by ~40% compared to standard networking
  - Requires D-series or higher VM sizes

## Orchestrator Options

```bash
./orchestrate.py [OPTIONS]
```

| Option | Env Var | Default | Description |
|--------|---------|---------|-------------|
| `--cloud` | - | `aws azure` | Cloud(s) to measure (can repeat: `--cloud aws --cloud azure`) |
| `--ssh-key` | `SSH_KEY` | Auto | SSH private key (auto-detected from terraform output) |
| `--ssh-user` | - | Auto | SSH username (auto-detects per cloud) |
| `--tcp-duration` | `TCP_DURATION` | `5` | Duration for TCP latency test (seconds) |
| `--max-workers` | `PARALLEL_JOBS` | `10` | Max parallel SSH connections |
| `--terraform-dir` | - | `../terraform` | Base terraform directory |
| `--output-dir` | - | `../results/<timestamp>` | Output directory |
| `--inventory` | - | - | Use existing inventory JSON (skips terraform) |

## Measurement Methodology

- **Tool:** qperf (TCP latency measurement)
- **Protocol:** TCP data packet round-trip time
- **Samples:** 5 measurements per AZ pair
- **Statistics:** min/avg/max/stddev calculated from samples
- **Network:** Uses private IPs within each region

## Regions Covered

### AWS (17 regions)
- **Americas:** us-east-1, us-east-2, us-west-1, us-west-2, ca-central-1, sa-east-1
- **Europe:** eu-west-1, eu-west-2, eu-west-3, eu-central-1, eu-north-1
- **Asia Pacific:** ap-south-1, ap-northeast-1, ap-northeast-2, ap-northeast-3, ap-southeast-1, ap-southeast-2

### Azure (25 regions with Availability Zones)
- **Americas:** eastus, eastus2, westus2, westus3, centralus, southcentralus, canadacentral, brazilsouth
- **Europe:** uksouth, westeurope, northeurope, francecentral, germanywestcentral, norwayeast, swedencentral, switzerlandnorth
- **Middle East/Africa:** uaenorth, southafricanorth, qatarcentral
- **Asia Pacific:** australiaeast, southeastasia, eastasia, japaneast, koreacentral, centralindia

## Cost Estimate

### AWS
- 2-6 c5n.large instances per region (one per supported AZ)
- ~50-60 instances total across 17 regions
- Running for ~1 hour: approximately $6.00-8.00 USD total

### Azure
- 3 Standard_D2s_v3 VMs per region (zones 1, 2, 3)
- ~75 VMs total across 25 regions
- Running for ~1 hour: approximately $7.00-8.00 USD total

### Combined
- Total: ~$13.00-16.00 USD per hour

## Prerequisites

- Terraform >= 1.0
- Python 3.8+
- **For AWS:** AWS CLI configured with appropriate permissions
- **For Azure:** Azure CLI installed and logged in (`az login`)

## Output

Results are saved to `results/<timestamp>/`:
- `inventory.json` - All deployed instances
- `results.json` - Raw measurement data
- `report.md` - Markdown report with statistics

## Cleanup

**Important:** Always destroy the infrastructure when done to avoid ongoing charges.

```bash
# AWS
cd terraform/aws && terraform destroy

# Azure
cd terraform/azure && terraform destroy
```
